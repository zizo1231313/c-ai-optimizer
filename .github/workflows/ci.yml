name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-test-lint:
    name: Build, Test, and Lint
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Cache APT packages
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: cmake clang-format
        version: 1.0

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake clang-format

    - name: Lint C code
      run: |
        find src/ src_optimized/ include/ tests/ -name "*.c" -o -name "*.h" | \
        xargs clang-format --dry-run --Werror --style=file

    - name: Build both versions
      run: ./bin/build.sh both

    - name: Run all tests
      run: ./bin/test.sh both

    - name: Check optimizations are up-to-date
      run: ./bin/check_changes.sh

    - name: Run benchmark
      run: ./bin/benchmark.sh
